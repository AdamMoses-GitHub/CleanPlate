services:
  # The Web Server (PHP + Apache)
  php-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cleanplate-php-server
    ports:
      - "${APP_PORT:-8000}:80"
    environment:
      PHP_MEMORY_LIMIT: 256M
      # Pass environment variables to container
      APP_ENV: ${APP_ENV:-production}
      APP_DEBUG: ${APP_DEBUG:-false}
      CONFIDENCE_DEBUG: ${CONFIDENCE_DEBUG:-false}
      
      # Database
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE:-cleanplate}
      DB_USERNAME: ${DB_USERNAME:-cleanplate_user}
      DB_PASSWORD: ${DB_PASSWORD:-}
      
      # Security
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-*}
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_REQUESTS: ${RATE_LIMIT_REQUESTS:-10}
      RATE_LIMIT_PERIOD: ${RATE_LIMIT_PERIOD:-60}
      
      # Scraper
      SCRAPER_TIMEOUT: ${SCRAPER_TIMEOUT:-10}
      SCRAPER_MIN_DELAY: ${SCRAPER_MIN_DELAY:-2}
      
      # Cache
      CACHE_DRIVER: ${CACHE_DRIVER:-file}
      REDIS_HOST: ${REDIS_HOST:-redis}
    depends_on:
      - db
      - redis

  # The Database (MySQL)
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root_password}
      MYSQL_DATABASE: ${DB_DATABASE:-cleanplate}
      MYSQL_USER: ${DB_USERNAME:-cleanplate_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-}
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "${DB_PORT_EXTERNAL:-3306}:3306"

  # Redis Cache (for future use)
  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT_EXTERNAL:-6379}:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD:-}

  # Database Management (phpMyAdmin)
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    ports:
      - "${PHPMYADMIN_PORT:-8081}:80"
    environment:
      PMA_HOST: db
      PMA_USER: root
      PMA_PASSWORD: ${DB_ROOT_PASSWORD:-root_password}
    depends_on:
      - db

volumes:
  mysql_data: