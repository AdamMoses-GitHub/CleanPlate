# Deploying CleanPlate to a VPS / Shared Hosting

This document covers everything required to deploy CleanPlate to a traditional PHP+Apache
hosting environment (no Docker involved).

---

## Prerequisites

| Requirement | Version |
|---|---|
| PHP | 8.1 or higher (8.2 recommended) |
| Apache | 2.4+ with `mod_rewrite` enabled |
| MySQL | 5.7+ or 8.0 (recommended) |
| PHP extensions | `pdo`, `pdo_mysql`, `curl`, `mbstring`, `json` |

> **Zero Composer dependencies.** The entire application is vanilla PHP — just upload the files.

---

## How the Paths Work

CleanPlate separates its files intentionally:

- **`public/`** — the only directory exposed to the web (Apache `DocumentRoot`)
- Everything else (`includes/`, `config/`, `storage/`, `.env`) lives **above** the web root
  and is never directly accessible via a browser

All `require_once` paths in PHP files use relative traversal (e.g. `../../includes/Config.php`),
so the same code works on both a VPS (`/var/www/cleanplate/`) and shared hosting
(`/home/user/` with `public_html/` as the web root) without any changes.

---

## Remote File Structure

### Option A — VPS (recommended)

You control the Apache config and can point `DocumentRoot` anywhere.

```
/var/www/cleanplate/                  ← project root (not web-accessible)
│
├── .env                              ← your secrets — never commit this
│
├── includes/                         ← PHP classes
│   ├── Config.php
│   ├── ConfigValidator.php
│   ├── IngredientFilter.php
│   └── RecipeParser.php
│
├── config/                           ← config files
│   ├── app.php
│   ├── cache.php
│   ├── database.php
│   ├── mail.php
│   ├── scraper.php
│   ├── security.php
│   └── services.php
│
├── storage/                          ← writable by the web server
│   ├── cache/
│   ├── logs/
│   └── temp/
│
└── public/                           ← Apache DocumentRoot → points here
    │
    ├── index.php                     ← homepage (visit tracking + carousel)
    │
    ├── css/
    │   └── style.css
    │
    ├── js/
    │   └── app.js
    │
    ├── data/                         ← created automatically on first publish
    │   └── featured.json             ← generated by admin → do not commit
    │
    ├── api/
    │   ├── parser.php                ← recipe scraping endpoint (POST)
    │   ├── config-test.php           ← remove or protect in production
    │   └── .htaccess                 ← disables directory listing
    │
    ├── admin/
    │   ├── index.php                 ← dashboard
    │   ├── login.php
    │   ├── logout.php
    │   ├── extractions.php
    │   ├── extraction-detail.php
    │   ├── featured.php
    │   ├── analytics.php
    │   ├── export.php
    │   ├── _header.php
    │   └── _footer.php
    │
    └── tests/                        ← remove or restrict in production
        ├── index.html
        ├── system-check.php
        └── ...
```

### Option B — Shared Hosting (cPanel / Plesk)

Most shared hosts only let you use `public_html/` as the web root. Put the non-public
files in your home directory, **above** `public_html/`.

```
/home/yourusername/                   ← home directory (not web-accessible)
│
├── .env                              ← your secrets
│
├── includes/                         ← PHP classes
│   └── (same as above)
│
├── config/                           ← config files
│   └── (same as above)
│
├── storage/                          ← writable by the web server
│   ├── cache/
│   ├── logs/
│   └── temp/
│
└── public_html/                      ← web root — upload contents of public/ here
    ├── index.php
    ├── css/
    ├── js/
    ├── data/
    ├── api/
    ├── admin/
    └── tests/
```

> The relative path `../../includes/Config.php` from `public_html/api/parser.php` resolves to
> `/home/yourusername/includes/Config.php` — this works without any code changes.

---

## Step-by-Step Deployment

### 1. Create the database

Log into phpMyAdmin, cPanel's MySQL tool, or the MySQL CLI and run the two migration files
in order:

```sql
-- Run 1st:
source .docker/mysql/01_recipe_extractions.sql

-- Run 2nd:
source .docker/mysql/02_site_visits.sql
```

Note the database name, username, and password your host assigns.

---

### 2. Create your `.env` file

Copy `.env.example` to `.env` (at the project root, **not** inside `public/`) and fill in
your real values:

```dotenv
# ── Core ──────────────────────────────────────────────────
APP_ENV=production
APP_DEBUG=false
APP_TIMEZONE=UTC

# ── Database ──────────────────────────────────────────────
DB_CONNECTION=mysql
DB_HOST=localhost           # almost always localhost on shared hosting
DB_PORT=3306
DB_DATABASE=your_db_name
DB_USERNAME=your_db_user
DB_PASSWORD=your_db_password

# ── Admin ─────────────────────────────────────────────────
ADMIN_USERNAME=admin
ADMIN_PASSWORD=pick_a_strong_password_here

# ── Scraper tweaks (optional) ─────────────────────────────
SCRAPER_TIMEOUT=10
FEATURED_SUBSET_SIZE=5
CACHE_TTL_HOURS=24

# ── Storage paths ─────────────────────────────────────────
# VPS:            /var/www/cleanplate/storage/logs
# Shared hosting: /home/yourusername/storage/logs
LOG_DIR=/home/yourusername/storage/logs
TEMP_DIR=/home/yourusername/storage/temp
```

---

### 3. Upload the files

**Via FTP/SFTP:**

| Local path | Upload to (VPS) | Upload to (shared hosting) |
|---|---|---|
| `includes/` | `/var/www/cleanplate/includes/` | `/home/user/includes/` |
| `config/` | `/var/www/cleanplate/config/` | `/home/user/config/` |
| `storage/` | `/var/www/cleanplate/storage/` | `/home/user/storage/` |
| `.env` | `/var/www/cleanplate/.env` | `/home/user/.env` |
| `public/` contents | `/var/www/cleanplate/public/` | `/home/user/public_html/` |

**Do NOT upload:**
- `.git/` — source control metadata
- `.docker/` — Docker dev tooling only
- `docker-compose.yml` / `Dockerfile` — local dev only
- `public/tests/` — development test pages (or at minimum, protect them)
- `public/api/config-test.php` — exposes configuration details

---

### 4. Set directory permissions

The web server process (typically `www-data` on Ubuntu, `apache` on cPanel) needs write
access to the three storage directories:

```bash
# VPS (bash)
chmod 775 /var/www/cleanplate/storage/cache
chmod 775 /var/www/cleanplate/storage/logs
chmod 775 /var/www/cleanplate/storage/temp

# If SELinux is enforcing (CentOS/RHEL):
chcon -Rt httpd_sys_rw_content_t /var/www/cleanplate/storage/
```

On shared hosting, your FTP client can set permissions (right-click → File Permissions → 755/775).

The `public/data/` directory is created automatically the first time you publish featured
recipes from the admin panel — the web server process must be able to write inside `public/`.

---

### 5. Configure Apache (VPS only)

Create a virtual host file, e.g. `/etc/apache2/sites-available/cleanplate.conf`:

```apache
<VirtualHost *:80>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com

    DocumentRoot /var/www/cleanplate/public

    <Directory /var/www/cleanplate/public>
        AllowOverride All
        Require all granted
        Options -Indexes
    </Directory>

    # Block direct access to everything above public/
    <Directory /var/www/cleanplate>
        Require all denied
    </Directory>
    <Directory /var/www/cleanplate/public>
        Require all granted
    </Directory>

    ErrorLog  /var/log/apache2/cleanplate_error.log
    CustomLog /var/log/apache2/cleanplate_access.log combined
</VirtualHost>
```

Enable and reload:

```bash
a2ensite cleanplate.conf
a2enmod rewrite
systemctl reload apache2
```

For HTTPS, run Certbot afterwards:

```bash
certbot --apache -d yourdomain.com -d www.yourdomain.com
```

---

### 6. Verify the deployment

Open your browser and check:

| URL | Expected result |
|---|---|
| `https://yourdomain.com/` | Homepage with carousel |
| `https://yourdomain.com/admin/` | Admin login page |
| `https://yourdomain.com/api/parser.php` | JSON error (POST required) — correct |
| `https://yourdomain.com/storage/` | 403 Forbidden |
| `https://yourdomain.com/.env` | 403 Forbidden |

Log into the admin panel, navigate to **Featured**, and click **Publish to Homepage** to
generate `public/data/featured.json` for the first time.

---

## Security Checklist

- [ ] `APP_DEBUG=false` in `.env`
- [ ] `APP_ENV=production` in `.env`
- [ ] Strong, unique `ADMIN_PASSWORD` set in `.env`
- [ ] `.env` is not web-accessible (verify with a browser — must return 403)
- [ ] `public/tests/` removed or protected with HTTP auth
- [ ] `public/api/config-test.php` removed
- [ ] `storage/` directories are writable but not web-accessible
- [ ] HTTPS enabled (Certbot / hosting SSL)
- [ ] `DB_ROOT_PASSWORD` is not set in `.env` (Docker-only variable, not needed on VPS)

---

## What Stays Local (Never Goes to the Server)

| Item | Reason |
|---|---|
| `docker-compose.yml` | Local dev environment only |
| `Dockerfile` | Local dev environment only |
| `.docker/` | Docker config and SQL dev scripts (migrations are run manually) |
| `.env` | Contains secrets — gitignored |
| `public/data/featured.json` | Generated at runtime — gitignored |
| `storage/cache/*` | Runtime cache — gitignored |
| `storage/logs/*` | Runtime logs — gitignored |
| `storage/temp/*` | Temporary files — gitignored |
